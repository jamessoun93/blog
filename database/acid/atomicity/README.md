# [ACID #2] Atomicity란? 아토믹한 트랜잭션이란?

[Tistory 블로그 포스팅 바로가기](https://seunghyunson.tistory.com/11)

**Atomicity**는 RDBMS를 정의하는 **ACID 트랜잭션** 특성 중 `A`에 해당하는 특성입니다.

한글로 직역하면 원자성이라는 뜻을 가지며 왜 트랜잭션에서 Atomicity란 특성이 중요한지에 대해 알아봅시다.

## Atomicity (원자성)

**1. 트랜잭션의 모든 쿼리는 성공해야 합니다.**

   원자성이란 어떤 것이 더 이상 쪼개질 수 없는 성질을 말합니다. 트랜잭션에서는 여러 가지 작업이 하나의 작업으로 간주됩니다. 원자(atom)와 같이 쪼갤 수 없다는 뜻이죠.

**2. 만약 트랜잭션 도중 어떤 이유에서건 하나의 쿼리가 실패한다면 해당 트랜잭션 내 실패한 쿼리 이전에 성공적으로 실행됐던 모든 쿼리들은 ROLLBACK 되어야 합니다.**

   쿼리가 실패하는 경우는 다양한 이유가 될 수 있습니다. 예를 들어, 계좌 잔액처럼 0 밑으로 내려가면 안 되는 상황에 잔액이 음수가 된다던지, 중복 고유 키, 아니면 잘못된 SQL 구문도 될 수 있습니다.

**3. 트랜잭션을 커밋하기 전에 데이터베이스에 💥CRASH가 발생해 (실패한 쿼리가 아닌 경우) 멈추게 된다면 트랜잭션 내 성공한 모든 쿼리가 ROLLBACK 되어야 합니다.**

   문제를 해결하고 복구되었을 때 데이터베이스는 트랜잭션 중 발생한 오류를 감지하고 **ROLLBACK** 해야 합니다.

## Example

| account_id | balance |
|------------|---------|
| 1          | $1000   |
| 2          | $500    |

Account 1에서 Account 2로 $100를 송금하는 상황

```sql
BEGIN;
    SELECT balance FROM accounts WHERE id = 1;
    
    UPDATE accounts SET balance = balance - 100 WHERE id = 1;
```
Account 1의 balance에서 $100을 차감하는 순간 문제가 발생하여 💥CRASH가 발생해 데이터베이스가 다운되었다고 가정해봅시다.

| account_id | balance |
|------------|---------|
| 1          | $900    |
| 2          | $500    |

만약 데이터베이스가 복구되었을 때 오류를 감지하지 못해 ROLLBACK이 되지 않은 상태로 남는다면 **Atomicity(원자성)**을 보장하지 않게 되어 저장된 데이터가 **Inconsistent(불일치)**하게 되는 현상이 생기게 됩니다.

그렇다면 **Account 1**의 **balance는** 기존 **$1000**에서 **$100**를 차감한 **$900**로 남아있게 되고, **Account 2**의 **balance는** **$500**로 변화가 없는 상태가 됩니다.

이런 경우를 방지하기 위해 데이터베이스가 다시 복구됐을 때 꼭 **ROLLBACK**을 할 수 있어야 합니다.

## Summary

- 트랜잭션은 아토믹 해야 하며 하나 이상의 쿼리가 실패할 경우 모든 쿼리를 롤백해야 합니다.
- 100개의 쿼리 중 하나라도 실패한다면 100개의 쿼리 모두 롤백되어야 합니다.